package com.sdase.malware.services;


import com.sdase.malware.dummyIbans.BlacklistedIbans;
import com.sdase.malware.dummyIbans.Ibans;
import com.sdase.malware.interfaces.Consumer;
import com.sdase.malware.model.CheckEvent;
import com.sdase.malware.model.CheckResultEvent;
import com.sdase.malware.model.FraudProtection;
import com.sdase.malware.utils.FileLoader;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.kafka.annotation.KafkaListener;
import org.springframework.stereotype.Service;

import java.util.List;


@Slf4j
@Service
public class KafkaConsumer implements Consumer {

    @Autowired
    private FileLoader fileLoader;

    private String IBAN="";

    @Override
    @KafkaListener(topics = "${spring.kafka.template.default-topic}", groupId="${spring.kafka.consumer.group-id}",
            containerFactory="fraudProtectionKafkaListenerContainerFactory")
    public CheckResultEvent consumeFromTopic(CheckEvent checkEvent) {
        log.info("Message consumed");
        CheckResultEvent checkResultEvent = new CheckResultEvent();
        checkResultEvent.setName("Fraud Detection");

        try{
            IBAN = fileLoader.loadFileFromUrl(checkEvent.getUrl());
        }
        catch (Exception e){
            log.error("Exception occurred here "+e.getLocalizedMessage());
            e.printStackTrace();
        }

        if(IBAN!=null){
            //check if IBAN exists in the accepted IBAN list..
            BlacklistedIbans blacklistedIbans = new BlacklistedIbans();
            List<Ibans> listOfBlacklistedIbans = blacklistedIbans.getAcceptedIbans();
            boolean ibanStatus = listOfBlacklistedIbans.contains(new Ibans(IBAN));

            if(ibanStatus == true){
                checkResultEvent.setState(CheckResultEvent.StateEnum.ERROR);
                checkResultEvent.setDetails("THIS IBAN "+IBAN+" IS BLACKLISTED");
            }else{
                checkResultEvent.setState(CheckResultEvent.StateEnum.OK);
                checkResultEvent.setDetails("THIS IBAN "+IBAN+" IS ACCEPTED");
            }
        }

        log.info(checkResultEvent.toString());
        return checkResultEvent;
    }

}
